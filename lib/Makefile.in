topsrc = @top_srcdir@

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
CC = @CC@
CFLAGS = @CFLAGS@
MAKE = @MAKE@
INSTALL = @INSTALL@
LN = @LN_S@
XML_CFLAGS = @XML_CFLAGS@
XML_LIBS = @XML_LIBS@
GLIB_CFLAGS = @GLIB_CFLAGS@
GLIB_LIBS = @GLIB_LIBS@
GMP_CFLAGS = @GMP_CFLAGS@
GMP_LIBS = @GMP_LIBS@
have_gtk = @have_gtk@

ifeq ($(INSTALL_PROGRAM),)
  INSTALL_PROGRAM = $(INSTALL) -m 755
endif
ifeq ($(INSTALL_DATA),)
  INSTALL_DATA = $(INSTALL) -m 644
endif
ifeq ($(LN),)
  LN = ln -sf
endif

# Installation directories
libdir = $(prefix)/lib
includedir = $(prefix)/include/gretl
aclocaldir = $(prefix)/share/aclocal
pkgconfigdir = $(libdir)/pkgconfig

INSTALLDIRS = $(libdir) $(includedir) $(aclocaldir)

LIBGRETL = libgretl-1.0.la 

# Libraries:
ifeq ($(have_gtk),2.0)
  INSTALLDIRS += $(pkgconfigdir)
  INSTALL_CFG = install-cfg-new
else
  INSTALL_CFG = install-cfg-old
endif

LIBS = -lm -ldl -L/usr/local/lib -lz $(XML_LIBS) $(GLIB_LIBS) $(GMP_LIBS)

#### End of system configuration section. ####

libsrc  = $(topsrc)/lib/src
cephessrc = $(topsrc)/cephes
VPATH = $(libsrc):$(cephessrc)

libdir = $(prefix)/lib
includedir = $(prefix)/include/gretl

SRCS = calendar.c compare.c dataio.c describe.c discrete.c \
	errors.c estimate.c generate.c graphing.c \
	gretl_utils.c interact.c modelprint.c monte_carlo.c nonparam.c \
	printout.c pvalues.c random.c strutils.c subsample.c system.c \
	texprint.c var.c 

HDRS = libgretl.h commands.h estimate.h gretl_utils.h errors.h pvalues.h \
	random.h compare.h dataio.h generate.h strutils.h describe.h \
	printout.h modelprint.h version.h texprint.h var.h interact.h graphing.h \
	monte_carlo.h nonparam.h discrete.h subsample.h system.h calendar.h \
	internal.h ../cephes/libprob.h

CEPHES_SRC = bdtr.c btdtr.c chbevl.c chdtr.c const.c drand.c expx2.c \
	   fdtr.c gamma.c gdtr.c igam.c igami.c incbet.c incbi.c \
	   mtherr.c nbdtr.c ndtr.c ndtri.c pdtr.c polevl.c \
	   stdtr.c unity.c 

OBJS = $(SRCS:.c=.o)
LOBJS = $(SRCS:.c=.lo)
CEPHES_OBJ = $(CEPHES_SRC:.c=.o)
CEPHES_LOBJ = $(CEPHES_SRC:.c=.lo)

LIBTOOL = ../libtool

override CFLAGS += -I.. -I$(topsrc) -I$(libsrc) $(XML_CFLAGS) $(GLIB_CFLAGS) $(GMP_CFLAGS) -DHAVE_CONFIG_H

COMPILE = $(LIBTOOL) --mode=compile $(CC) -c $(CFLAGS)

.c.o:        
	$(COMPILE) $<

%.d: %.c
	set -e; $(CC) -MM -MG -I$(libsrc) $< 2>/dev/null \
	| sed 's/\($*\)\.o[ :]*/\1.o $@ : /g' > $@ ; \
	[ -s $@ ] || rm -f $@

$(LIBGRETL): $(OBJS) $(LOBJS) $(CEPHES_OBJ) $(CEPHES_LOBJ)
	$(LIBTOOL) --mode=link $(CC) -o $@ $(LOBJS) $(CEPHES_LOBJ) \
	-rpath $(prefix)/lib $(LIBS) -version-info 0:6:0

include $(SRCS:.c=.d)

.PHONY: 

install: $(LIBGRETL) install-data
	$(LIBTOOL) $(INSTALL_PROGRAM) $< $(libdir)/$<

install-strip: $(LIBGRETL) install-data
	$(LIBTOOL) $(INSTALL_PROGRAM) -s $< $(libdir)/$<

install-data: installdirs $(INSTALL_CFG)
	$(INSTALL_DATA) $(libsrc)/*.h $(includedir)
	$(INSTALL_DATA) $(cephessrc)/libprob.h $(includedir)

install-cfg-old: ../gretl-config
	$(INSTALL_PROGRAM) ../gretl-config $(bindir)
	$(INSTALL_DATA) $(topsrc)/gretl.m4 $(aclocaldir)

install-cfg-new: ../gretl.pc
	$(INSTALL_DATA) ../gretl.pc $(pkgconfigdir)

installdirs:
	$(topsrc)/tools/mkinstalldirs $(INSTALLDIRS)

clean:
	rm -f *.o *.lo *.d $(LIBGRETL) core 
	rm -rf ./.libs

tags:
	$(MAKE) -C $(topsrc) tags



