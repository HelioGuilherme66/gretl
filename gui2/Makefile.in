topsrc = @top_srcdir@
datarootdir = @datarootdir@

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
libdir = @libdir@
CC = @CC@
CFLAGS = @CFLAGS@
MAKE = @MAKE@
INSTALL = @INSTALL@
LN = @LN_S@
have_readline = @have_readline@
have_sourceview = @have_sourceview@
have_zlib = @have_zlib@
have_gnome = @have_gnome@
gnome_prefix = @gnome_prefix@

GNOME_CFLAGS = @GNOME_CFLAGS@
GNOME_LIBS = @GNOME_LIBS@
GTK_CFLAGS = @GTK_CFLAGS@
GTK_LIBS = @GTK_LIBS@
GDK_PIXBUF_CFLAGS = @GDK_PIXBUF_CFLAGS@
GDK_PIXBUF_LIBS = @GDK_PIXBUF_LIBS@
GTKSOURCEVIEW_CFLAGS = @GTKSOURCEVIEW_CFLAGS@
GTKSOURCEVIEW_LIBS = @GTKSOURCEVIEW_LIBS@
XML_CFLAGS = @XML_CFLAGS@
XML_LIBS = @XML_LIBS@
USE_NLS = @USE_NLS@
INETLIB = @INETLIB@
CARBONLIB = @CARBONLIB@

# Bundled gtkextra subset
GTK_EXTRA_CFLAGS = -I$(topsrc)/gui2/gtkextra-lite
GTK_EXTRA_LIB = -L./gtkextra-lite -lgtkextra-lite

GRETL_LANG = gretl.lang
GNUPLOT_LANG = gnuplot.lang
R_LANG = R.lang

# Bundled gtksourceview subset?
ifeq ($(have_sourceview),no)
  GTKSOURCEVIEW_CFLAGS = -I$(topsrc)/gui2
  GTKSOURCEVIEW_LIBS = -L./gtksourceview -lgtksourceview-lite
  langdir = $(prefix)/share/gretl/gtksourceview
  GTKSOURCEVIEW_LITE = gtksourceview/libgtksourceview-lite.a
  query_install_Rlang = install-Rlang
endif

ifeq ($(have_sourceview),2.0)
  svprefix = $(shell pkg-config --variable=prefix gtksourceview-2.0)
  langdir = $(svprefix)/share/gtksourceview-2.0/language-specs
  LANGOPT = --lang2
  GRETL_LANG = gretl.lang.2
  GNUPLOT_LANG = gnuplot.lang.2
endif

ifeq ($(have_sourceview),1.0)
  svprefix = $(shell pkg-config --variable=prefix gtksourceview-1.0)
  langdir = $(svprefix)/share/gtksourceview-1.0/language-specs
endif

ifeq ($(CC),)
  CC = gcc
endif
ifeq ($(INSTALL_PROGRAM),)
  INSTALL_PROGRAM = $(INSTALL) -m 755
endif
ifeq ($(INSTALL_DATA),)
  INSTALL_DATA = $(INSTALL) -m 644
endif
ifeq ($(LN),)
  LN = ln -sf
endif

ifeq ($(have_gnome),2.0)
  G_LIBS = $(GNOME_LIBS)
  G_CFLAGS = $(GNOME_CFLAGS)
  query_install_gnome = install-gnome
  GNOMEDEF = -DDATADIR=\"$(gnome_prefix)/share\"
else
  G_LIBS = $(GTK_LIBS)
  G_CFLAGS = $(GTK_CFLAGS)
endif

LIBS = $(G_LIBS) $(GTKSOURCEVIEW_LIBS) $(GTK_EXTRA_LIB) ../lib/libgretl-1.0.la
GUI_CFLAGS = $(G_CFLAGS) $(GTKSOURCEVIEW_CFLAGS) $(GTK_EXTRA_CFLAGS)

ifeq ($(USE_NLS),yes)
  datadir = @datadir@
  localedir = $(datadir)/locale
  NLSDEF = -DLOCALEDIR=\"$(localedir)\"
endif

DEFS = $(NLSDEF) $(GNOMEDEF)

override CFLAGS += -I.. -I$(libsrc) $(GUI_CFLAGS) \
	$(GDK_PIXBUF_CFLAGS) $(XML_CFLAGS) $(DEFS)
override LIBS += $(GDK_PIXBUF_LIBS)

# Directories
bindir	= $(prefix)/bin
gretldir = $(prefix)/share/gretl
uidir = $(prefix)/share/gretl/ui
tooldir = $(topsrc)/tools
libsrc = $(topsrc)/lib/src
clisrc = $(topsrc)/cli
docdir = $(topsrc)/doc

#### End of system configuration section. ####

SHELL = /bin/sh
LIBTOOL = ../libtool
PROG  = gretl_x11

vpath %.c $(topsrc)/gui2
vpath %.h $(topsrc)/gui2

SRCS = about.c \
	boxplots.c \
	calculator.c \
	callbacks.c \
	clipboard.c \
	cmdstack.c \
	console.c \
	database.c \
	datafiles.c \
	dialogs.c \
	dlgutils.c \
	filelists.c \
	fileselect.c \
	filters.c \
	fncall.c \
	fnsave.c \
	graph_page.c \
	gpt_control.c \
	gpt_dialog.c \
	gretl.c \
	guiprint.c \
	gui_recode.c \
	gui_utils.c \
	helpfiles.c \
	library.c \
	menustate.c \
	model_table.c \
	objectsave.c \
	obsbutton.c \
	selector.c \
	series_view.c \
	session.c \
	settings.c \
	ssheet.c \
	textbuf.c \
	textutil.c \
	toolbar.c \
	treeutils.c \
	update.c

OBJS = $(SRCS:.c=.o)

HACK_SRC = gtkfontselhack.c
HACK_HDR = gtkfontselhack.h
HACK_OBJ = gtkfontselhack.o

GTKEXTRA_LITE = gtkextra-lite/libgtkextra-lite.a

%.o: %.c
	$(CC) -c $(CFLAGS) $<
	$(CC) $(CFLAGS) -MM $< > .deps/$*.d 

$(PROG): .deps $(OBJS) $(HACK_OBJ) $(GTKEXTRA_LITE) $(GTKSOURCEVIEW_LITE) 
	$(LIBTOOL) --mode=link $(CC) -o $@ $(OBJS) $(HACK_OBJ) $(LIBS) $(INETLIB) $(CARBONLIB)

$(HACK_OBJ): $(HACK_SRC) $(HACK_HDR)
	$(CC) $(CFLAGS) $(GTK_CFLAGS) -c $<

mklang: mklang.o
	$(LIBTOOL) --mode=link $(CC) -o $@ $< ../lib/libgretl-1.0.la $(XML_LIBS)

mklang.o: mklang.c $(topsrc)/lib/src/options.c $(topsrc)/lib/src/genlex.c
	$(CC) -c -I.. -I$(libsrc) $(XML_CFLAGS) $<

$(GRETL_LANG): mklang
	./mklang $(LANGOPT) > $@

$(GTKEXTRA_LITE): 
	make -C gtkextra-lite

$(GTKSOURCEVIEW_LITE):
	make -C gtksourceview

.deps:
	mkdir $@

-include .deps/*.d

.PHONY:

install: install-exec install-data install-lang $(query_install_gnome)

install-strip: $(PROG) install-data $(query_install_gnome)
	$(LIBTOOL) --mode=install $(INSTALL_PROGRAM) -s $(PROG) $(DESTDIR)$(bindir)/$(PROG)

install-data: installdirs
	$(INSTALL_PROGRAM) ../gretl_sh $(DESTDIR)$(bindir)/gretl
	$(INSTALL_DATA) $(topsrc)/pixmaps/gretl-logo.xpm $(DESTDIR)$(gretldir)
	$(INSTALL_DATA) $(topsrc)/COPYING $(DESTDIR)$(gretldir)
	$(INSTALL_DATA) $(topsrc)/gui2/gretlmain.xml $(DESTDIR)$(uidir)
	$(INSTALL_DATA) $(topsrc)/gui2/modelmenu.xml $(DESTDIR)$(uidir)

install-exec: $(PROG) installdirs 
	$(LIBTOOL) --mode=install $(INSTALL_PROGRAM) $(PROG) $(DESTDIR)$(bindir)/$(PROG)

install-gnome: $(PROG) installdirs 
	$(MAKE) -C ../gnome install 

install-Rlang: $(topsrc)/gui2/R.lang
	$(INSTALL_DATA) $(topsrc)/gui2/R.lang $(DESTDIR)$(langdir)

install-lang: $(GRETL_LANG) installdirs $(query_install_Rlang)
	$(INSTALL_DATA) $(GRETL_LANG) $(DESTDIR)$(langdir)/gretl.lang
	$(INSTALL_DATA) $(topsrc)/gui2/$(GNUPLOT_LANG) $(DESTDIR)$(langdir)/gnuplot.lang

installdirs:
	$(tooldir)/mkinstalldirs $(DESTDIR)$(bindir) 
	$(tooldir)/mkinstalldirs $(DESTDIR)$(gretldir)
	$(tooldir)/mkinstalldirs $(DESTDIR)$(langdir)
	$(tooldir)/mkinstalldirs $(DESTDIR)$(uidir)

clean:
	rm -f *.o $(PROG)
	rm -rf .libs .deps
	make -C gtkextra-lite clean
	make -C gtksourceview clean

distclean: clean
	rm -f Makefile debug

