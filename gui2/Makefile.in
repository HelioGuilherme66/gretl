topsrc = @top_srcdir@

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
libdir = @libdir@
CC = @CC@
CFLAGS = @CFLAGS@
MAKE = @MAKE@
INSTALL = @INSTALL@
LN = @LN_S@
have_readline = @have_readline@
have_zlib = @have_zlib@
have_gnome = @have_gnome@
gnome_prefix = @gnome_prefix@

GNOME_CFLAGS = @GNOME_CFLAGS@
GNOME_LIBS = @GNOME_LIBS@
GTK_CFLAGS = @GTK_CFLAGS@
GTK_LIBS = @GTK_LIBS@
PNG_CFLAGS = @PNG_CFLAGS@
PNG_LIBS = @PNG_LIBS@
GDK_PIXBUF_CFLAGS = @GDK_PIXBUF_CFLAGS@
GDK_PIXBUF_LIBS = @GDK_PIXBUF_LIBS@
USE_NLS = @USE_NLS@
INETLIB = @INETLIB@

GTK_EXTRA_CFLAGS = -I$(topsrc)/gui2/gtkextra-lite
GTK_EXTRA_LIB = -L./gtkextra-lite -lgtkextra-lite

ifeq ($(CC),)
  CC = gcc
endif
ifeq ($(INSTALL_PROGRAM),)
  INSTALL_PROGRAM = $(INSTALL) -m 755
endif
ifeq ($(INSTALL_DATA),)
  INSTALL_DATA = $(INSTALL) -m 644
endif
ifeq ($(LN),)
  LN = ln -sf
endif
ifeq ($(have_gnome),2.0)
  LIBS = $(GNOME_LIBS) $(GTK_EXTRA_LIB) ../lib/libgretl-1.0.la
  GUI_CFLAGS = $(GNOME_CFLAGS) $(GTK_EXTRA_CFLAGS)
  query_install_gnome = install-gnome
  GNOMEDEF = -DGNOME_DISABLE_DEPRECATED -DDATADIR=\"$(gnome_prefix)/share\"
else
  LIBS = $(GTK_LIBS) $(GTK_EXTRA_LIB) ../lib/libgretl-1.0.la
  GUI_CFLAGS = $(GTK_CFLAGS) $(GTK_EXTRA_CFLAGS)
endif
ifeq ($(USE_NLS),yes)
  datadir = @datadir@
  localedir = $(datadir)/locale
  NLSDEF = -DLOCALEDIR=\"$(localedir)\"
endif

DEFS = $(NLSDEF) $(GNOMEDEF)

override CFLAGS += -I.. -I$(libsrc) $(GUI_CFLAGS) $(PNG_CFLAGS) $(GDK_PIXBUF_CFLAGS) $(DEFS)
override LIBS += $(PNG_LIBS) $(GDK_PIXBUF_LIBS)

GUI_CFLAGS += -DGTK_DISABLE_DEPRECATED

# Directories
bindir	= $(prefix)/bin
gretldir = $(prefix)/share/gretl
tooldir = $(topsrc)/tools
libsrc = $(topsrc)/lib/src
clisrc = $(topsrc)/cli
docdir = $(topsrc)/doc

#### End of system configuration section. ####

SHELL = /bin/sh
LIBTOOL = ../libtool
PROG  = gretl_x11

VPATH = $(topsrc)/gui2:$(topsrc)/cli:..

SRCS = boxplots.c calculator.c callbacks.c console.c database.c \
	datafiles.c dialogs.c fileselect.c gpt_control.c gretl.c \
	guiprint.c gui_utils.c helpfiles.c library.c model_table.c \
	selector.c series_view.c session.c settings.c ssheet.c \
	treeutils.c webget.c 
OBJS = $(SRCS:.c=.o)

HACK_SRC = gtkfontselhack.c
HACK_HDR = gtkfontselhack.h
HACK_OBJ = gtkfontselhack.o

GTKEXTRA_LITE = gtkextra-lite/libgtkextra-lite.a

%.o: %.c
	$(CC) -c $(CFLAGS) $<
	$(CC) -MM -MG -I$(libsrc) $(GTK_EXTRA_CFLAGS) $(DEFS) $< > $*.d 2>/dev/null

$(PROG): $(OBJS) $(HACK_OBJ) $(GTKEXTRA_LITE)
	$(LIBTOOL) --mode=link $(CC) -o $@ $(OBJS) $(HACK_OBJ) $(LIBS) $(INETLIB)

$(HACK_OBJ): $(HACK_SRC) $(HACK_HDR)
	$(CC) $(CFLAGS) $(GTK_CFLAGS) -c $<

$(GTKEXTRA_LITE): 
	make -C gtkextra-lite

-include $(OBJS:.o=.d)

.PHONY:

install: $(PROG) install-data $(query_install_gnome)
	$(LIBTOOL) $(INSTALL_PROGRAM) $(PROG) $(bindir)/$(PROG)

install-strip: $(PROG) install-data $(query_install_gnome)
	$(LIBTOOL) $(INSTALL_PROGRAM) -s $(PROG) $(bindir)/$(PROG)

install-data: installdirs
	$(INSTALL_PROGRAM) ../gretl_sh $(bindir)/gretl
	$(INSTALL_DATA) $(topsrc)/pixmaps/gretl-logo.xpm $(gretldir)
	$(INSTALL_DATA) $(topsrc)/COPYING $(gretldir)

install-exec: $(PROG) installdirs 
	$(LIBTOOL) $(INSTALL_PROGRAM) $(PROG) $(bindir)/$(PROG)

install-gnome: $(PROG) installdirs 
	$(MAKE) -C ../gnome install 

installdirs:
	$(tooldir)/mkinstalldirs $(bindir) 
	$(tooldir)/mkinstalldirs $(gretldir)

clean:
	rm -f *.o *.d $(PROG) core
	rm -rf .libs
	make -C gtkextra-lite clean

distclean: clean
	rm -f Makefile debug

