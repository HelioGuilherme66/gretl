#!/bin/sh

# Shell script to make gretl2 win32 distribution

GNUPLOT_ZIPFILE=/home/ftp/pub/gretl/winbuild/gp372w32.zip

HOME_WIN32=/home/cottrell/stats/esl/win32
GTK2DLLS=$HOME_WIN32/dlls/gtk-2.0-dlls.tar.gz
GTK2MO=$HOME_WIN32/mo

INNO_EXE="c:/Userdata/Inno Setup 2/ISCC.exe"
RECODE=recode
THISDIR=`pwd`

# add gnuplot distribution
function process_gnuplot {
    unzip -X $GNUPLOT_ZIPFILE | grep gnuplot | grep -v /$ \
	| awk '{ print $NF }' >> MANIFEST
}

# create the gretl installer
function inno_compile {
    echo "Building gretl installer executable..."
    wine "$INNO_EXE" ./gretl.iss 2>/dev/null
    mv Output/setup.exe Output/gretl_install.exe
}

# Shouldn't have to make changes below here...

function add_file {
    if [ `basename $1` != "CVS" ] && [ ! -d $1 ] ; then
	cp -p $1 windist/$2
	echo $2
	echo $2 >> windist/MANIFEST
    fi
}

TOPDIR=..
VERSION=$(cat $TOPDIR/lib/src/version.h | grep version_ | \
     awk '{ print $NF}' | sed s/[\"\;]//g)

rm -f windist/MANIFEST
rm -rf windist/gretl windist/gnuplot

# make directory structure
mkdir -p windist
mkdir -p windist/gretl
mkdir -p windist/gretl/data
mkdir -p windist/gretl/data/greene
mkdir -p windist/gretl/scripts
mkdir -p windist/gretl/db
mkdir -p windist/gretl/user
mkdir -p windist/gretl/plugins
mkdir -p windist/gretl/locale/es/LC_MESSAGES
mkdir -p windist/gretl/lib/locale/es/LC_MESSAGES
mkdir -p windist/gretl/locale/fr/LC_MESSAGES
mkdir -p windist/gretl/lib/locale/fr/LC_MESSAGES

# put binaries in place
add_file gretlcli.exe gretl/gretlcli.exe
add_file gretlw32.exe gretl/gretlw32.exe

# home-made dynamic libs
for f in dlls/*.dll ; do
    add_file $f gretl/`basename $f`
done

# gretl plugins
for f in plugins/*.dll ; do
    add_file $f gretl/plugins/`basename $f`
done

# gtk dlls
for f in `tar tvfz $GTK2DLLS | grep -v /$ | awk '{ print $NF }'` ; do
    echo "gretl/$f" >> windist/MANIFEST
done
cd windist/gretl 
tar xvfz $GTK2DLLS
cd $THISDIR

# auxiliary dlls
for f in \
  iconv.dll libgmp.dll libintl-1.dll libxml.dll readline.dll zlib.dll
do
    add_file ../../gretl/win32/dlls/$f gretl/$f
done

# help files, license, logo
add_file ${TOPDIR}/share/gretlcli.hlp gretl/gretlcli_hlp.txt
for lang in es ; do
   $RECODE l1..utf-8 < ${TOPDIR}/share/gretl.hlp.$lang \
       > ${TOPDIR}/share/gretl_hlp_${lang}.txt
   add_file ${TOPDIR}/share/gretl_hlp_${lang}.txt \
       gretl/gretl_hlp_${lang}.txt
   $RECODE l1..utf-8 < ${TOPDIR}/share/gretlcli.hlp.$lang \
       > ${TOPDIR}/share/gretlcli_hlp_${lang}.txt
   add_file ${TOPDIR}/share/gretlcli_hlp_${lang}.txt \
       gretl/gretlcli_hlp_${lang}.txt
done
add_file ${TOPDIR}/share/gretl.hlp gretl/gretl_hlp.txt
add_file ${TOPDIR}/COPYING gretl/COPYING
add_file ${TOPDIR}/pixmaps/gretl-logo.xpm gretl/gretl-logo.xpm
add_file ${TOPDIR}/doc/htmlhelp/gretl.chm gretl/gretl.chm

# data files
for f in ${TOPDIR}/share/data/* ; do
    add_file $f gretl/data/`basename $f`
done
for f in ${TOPDIR}/share/data/greene/* ; do
    add_file $f gretl/data/greene/`basename $f`
done

# scripts
for f in ${TOPDIR}/share/scripts/* ; do
    add_file $f gretl/scripts/`basename $f`
done

# database files
add_file ${TOPDIR}/share/bcih/README gretl/db/README
add_file ${TOPDIR}/share/bcih/bcih.bin gretl/db/bcih.bin
add_file ${TOPDIR}/share/bcih/bcih.idx gretl/db/bcih.idx 

# translations
for lang in es fr ; do
  add_file mo/$lang.mo gretl/locale/$lang/LC_MESSAGES/gretl.mo
  add_file $GTK2MO/$lang/LC_MESSAGES/glib20.mo gretl/lib/locale/$lang/LC_MESSAGES/glib20.mo
  add_file $GTK2MO/$lang/LC_MESSAGES/gtk20.mo gretl/lib/locale/$lang/LC_MESSAGES/gtk20.mo
done

# misc files
add_file gretl_website.url gretl/gretl_website.url
add_file updater/gretl_updater.exe gretl/gretl_updater.exe
date > gretl.stamp
add_file gretl.stamp gretl/gretl.stamp

# add gnuplot distribution
cd windist
process_gnuplot

# make Inno builder file
cat MANIFEST | ./make_iss.pl $VERSION | todos > gretl.iss 

# make Inno installer
inno_compile
ls -l Output/gretl_install.exe

